<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotForm Table to Form Widget</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JotForm Custom Widget API -->
    <script src="https://js.jotform.com/JFCustomWidget.js"></script>

    <style>
        /* Custom styles to enhance the look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* A light gray background */
        }
        
        /* Style for the settings panel in the JotForm builder */
        .settings-panel {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Styling for the searchable dropdown in the live form */
        #search-container {
            position: relative;
        }

        #dropdown-options {
            max-height: 200px;
            overflow-y: auto;
            border-top: none;
            z-index: 10;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
        }

        /* Helper class to hide elements */
        .hidden {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="p-4 md:p-6">

    <!-- Main container for the widget -->
    <div id="widget-container">

        <!-- ====================================================== -->
        <!-- SETTINGS VIEW (Visible only in the JotForm Builder)    -->
        <!-- ====================================================== -->
        <div id="settings-view" class="hidden settings-panel space-y-6">
            <div>
                <h2 class="text-xl font-bold text-gray-800">Table to Form Widget Settings</h2>
                <p class="text-sm text-gray-500 mt-1">Connect a JotForm Table to auto-populate your form fields.</p>
            </div>

            <!-- API & Table Configuration -->
            <div class="space-y-4">
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700">JotForm API Key</label>
                    <input type="password" id="apiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Your API Key with Table Read access">
                </div>
                <div>
                    <label for="tableId" class="block text-sm font-medium text-gray-700">JotForm Table ID</label>
                    <input type="text" id="tableId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 230000000000000">
                </div>
                <div>
                    <label for="accessCodeColumn" class="block text-sm font-medium text-gray-700">Access Code Column Name</label>
                    <input type="text" id="accessCodeColumn" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="The column name for the searchable dropdown">
                     <p class="mt-1 text-xs text-gray-500">This must be the exact name of the column in your Table.</p>
                </div>
            </div>

            <!-- Field Mapping -->
            <div>
                <h3 class="text-lg font-medium text-gray-800">Field Mapping</h3>
                <p class="text-sm text-gray-500">Map Table columns to your form fields.</p>
                <div id="field-mappings-container" class="mt-4 space-y-3">
                    <!-- Dynamic mapping rows will be added here -->
                </div>
                <button id="add-mapping-btn" class="mt-4 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Add Mapping
                </button>
            </div>

            <!-- Save Button -->
            <div class="pt-4 border-t border-gray-200">
                <button id="save-settings-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Settings
                </button>
                <p id="settings-feedback" class="text-center mt-2 text-sm text-green-600"></p>
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- LIVE VIEW (Visible on the published form)              -->
        <!-- ====================================================== -->
        <div id="live-view" class="hidden">
            <div id="loading-state" class="text-center text-gray-600">
                <p>Loading data...</p>
            </div>
            <div id="error-state" class="hidden text-center text-red-600 p-4 bg-red-100 rounded-md">
                <p id="error-message"></p>
            </div>
            <div id="search-container" class="hidden">
                <label id="search-label" for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Select an entry</label>
                <input type="text" id="search-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search...">
                <div id="dropdown-options" class="hidden absolute w-full bg-white border border-gray-300 rounded-b-md shadow-lg">
                    <!-- Searchable options will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let tableData = []; // To store the full dataset from the JotForm Table
            let fieldMap = [];   // To store the field mapping configuration

            /**
             * Initializes the widget, determines the view (settings or live),
             * and sets up event listeners.
             */
            JFCustomWidget.subscribe('ready', () => {
                const settings = JFCustomWidget.getWidgetSettings();
                
                if (JFCustomWidget.isWidgetSettable()) {
                    // We are in the Form Builder -> show settings view
                    document.getElementById('settings-view').classList.remove('hidden');
                    setupSettingsView(settings);
                } else {
                    // We are on the live form -> show live view
                    document.getElementById('live-view').classList.remove('hidden');
                    setupLiveView(settings);
                }
            });

            /**
             * Sets up the settings view in the Form Builder.
             * @param {object} settings - The currently saved widget settings.
             */
            function setupSettingsView(settings) {
                // Populate fields with saved settings
                document.getElementById('apiKey').value = settings.apiKey || '';
                document.getElementById('tableId').value = settings.tableId || '';
                document.getElementById('accessCodeColumn').value = settings.accessCodeColumn || '';
                
                fieldMap = settings.fieldMap ? JSON.parse(settings.fieldMap) : [];
                renderFieldMappings();

                // Event Listeners for settings view
                document.getElementById('add-mapping-btn').addEventListener('click', addMappingRow);
                document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            }

            /**
             * Renders the field mapping rows based on the fieldMap array.
             */
            function renderFieldMappings() {
                const container = document.getElementById('field-mappings-container');
                container.innerHTML = ''; // Clear existing rows
                
                if (fieldMap.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">No mappings defined. Click "Add Mapping" to start.</p>';
                }

                fieldMap.forEach((mapping, index) => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center space-x-2';
                    row.innerHTML = `
                        <input type="text" value="${mapping.tableCol}" data-index="${index}" data-type="tableCol" class="flex-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Table Column Name">
                        <span class="text-gray-500">â†’</span>
                        <input type="text" value="${mapping.formField}" data-index="${index}" data-type="formField" class="flex-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Form Field Unique Name">
                        <button data-index="${index}" class="remove-mapping-btn p-1 text-red-500 hover:text-red-700">&times;</button>
                    `;
                    container.appendChild(row);
                });

                // Add event listeners for the new elements
                container.querySelectorAll('input').forEach(input => input.addEventListener('change', updateMappingFromInput));
                container.querySelectorAll('.remove-mapping-btn').forEach(btn => btn.addEventListener('click', removeMappingRow));
            }
            
            /**
             * Updates the fieldMap array when an input in the mapping UI changes.
             * @param {Event} e - The change event from the input field.
             */
            function updateMappingFromInput(e) {
                const index = e.target.dataset.index;
                const type = e.target.dataset.type;
                fieldMap[index][type] = e.target.value;
            }

            /**
             * Adds a new, empty row to the field mapping UI.
             */
            function addMappingRow() {
                fieldMap.push({ tableCol: '', formField: '' });
                renderFieldMappings();
            }

            /**
             * Removes a specific mapping row from the UI and the fieldMap array.
             * @param {Event} e - The click event from the remove button.
             */
            function removeMappingRow(e) {
                const index = e.target.dataset.index;
                fieldMap.splice(index, 1);
                renderFieldMappings();
            }

            /**
             * Collects and saves the widget settings to JotForm.
             */
            function saveSettings() {
                const settingsToSave = {
                    apiKey: document.getElementById('apiKey').value,
                    tableId: document.getElementById('tableId').value,
                    accessCodeColumn: document.getElementById('accessCodeColumn').value,
                    fieldMap: JSON.stringify(fieldMap.filter(m => m.tableCol && m.formField)) // Only save complete mappings
                };

                JFCustomWidget.sendData(settingsToSave);
                
                const feedback = document.getElementById('settings-feedback');
                feedback.textContent = 'Settings saved successfully!';
                setTimeout(() => feedback.textContent = '', 3000);

                // This tells JotForm builder that the widget is ready to be used.
                JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
            }

            /**
             * Sets up the live view on the published form.
             * @param {object} settings - The widget settings saved from the builder.
             */
            async function setupLiveView(settings) {
                const { apiKey, tableId, accessCodeColumn, fieldMap: fieldMapString } = settings;
                const parsedFieldMap = fieldMapString ? JSON.parse(fieldMapString) : [];

                if (!apiKey || !tableId || !accessCodeColumn) {
                    showError('Widget is not configured correctly. Please check settings in the Form Builder.');
                    return;
                }
                
                const searchLabel = document.getElementById('search-label');
                searchLabel.textContent = `Select ${accessCodeColumn}`;

                try {
                    const response = await fetch(`https://api.jotform.com/v1/tables/${tableId}/entries?apiKey=${apiKey}`);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data. Status: ${response.status}. Please check Table ID and API Key.`);
                    }
                    const data = await response.json();
                    tableData = data.content;
                    
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('search-container').classList.remove('hidden');

                    populateDropdown(tableData, accessCodeColumn);
                    setupSearchFunctionality(parsedFieldMap, accessCodeColumn);

                } catch (error) {
                    showError(error.message);
                }
            }

            /**
             * Populates the custom dropdown with options from the table data.
             * @param {Array} data - The array of row objects from the table.
             * @param {string} accessCodeColumn - The name of the column to use for options.
             */
            function populateDropdown(data, accessCodeColumn) {
                const dropdownOptions = document.getElementById('dropdown-options');
                dropdownOptions.innerHTML = ''; // Clear previous options
                data.forEach(entry => {
                    const value = entry[accessCodeColumn];
                    if (value) {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item p-2 cursor-pointer';
                        item.textContent = value;
                        item.dataset.value = value;
                        dropdownOptions.appendChild(item);
                    }
                });
            }

            /**
             * Sets up event listeners for the searchable dropdown functionality.
             * @param {Array} currentFieldMap - The parsed field mapping configuration.
             * @param {string} accessCodeColumn - The name of the access code column.
             */
            function setupSearchFunctionality(currentFieldMap, accessCodeColumn) {
                const searchInput = document.getElementById('search-input');
                const dropdown = document.getElementById('dropdown-options');
                const allOptions = Array.from(dropdown.querySelectorAll('.dropdown-item'));

                searchInput.addEventListener('focus', () => dropdown.classList.remove('hidden'));
                
                searchInput.addEventListener('blur', () => {
                    // Delay hiding to allow click event on items
                    setTimeout(() => dropdown.classList.add('hidden'), 200);
                });

                searchInput.addEventListener('input', () => {
                    const filter = searchInput.value.toLowerCase();
                    allOptions.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(filter) ? '' : 'none';
                    });
                });

                dropdown.addEventListener('click', (e) => {
                    if (e.target.classList.contains('dropdown-item')) {
                        const selectedValue = e.target.dataset.value;
                        searchInput.value = selectedValue;
                        dropdown.classList.add('hidden');
                        populateFormFields(selectedValue, currentFieldMap, accessCodeColumn);
                    }
                });
            }

            /**
             * Finds the selected entry and populates the form fields based on the mapping.
             * @param {string} selectedValue - The value chosen from the dropdown.
             * @param {Array} currentFieldMap - The field mapping configuration.
             * @param {string} accessCodeColumn - The name of the access code column.
             */
            function populateFormFields(selectedValue, currentFieldMap, accessCodeColumn) {
                const selectedEntry = tableData.find(entry => entry[accessCodeColumn] === selectedValue);
                if (!selectedEntry) return;

                const valuesToFill = {};
                currentFieldMap.forEach(mapping => {
                    if (selectedEntry.hasOwnProperty(mapping.tableCol)) {
                        valuesToFill[mapping.formField] = selectedEntry[mapping.tableCol];
                    }
                });

                JFCustomWidget.setFieldsValue(valuesToFill);
            }

            /**
             * Displays an error message in the live view.
             * @param {string} message - The error message to display.
             */
            function showError(message) {
                document.getElementById('loading-state').classList.add('hidden');
                const errorState = document.getElementById('error-state');
                document.getElementById('error-message').textContent = message;
                errorState.classList.remove('hidden');
            }

            // Adjust frame height on ready and after settings are saved
            JFCustomWidget.subscribe("ready", () => {
                JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
            });
            JFCustomWidget.subscribe("submit", () => {
                 JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
            });
        });
    </script>
</body>
</html>
